      - name: Build Backend Image (for tests)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          load: true
          tags: vempatisriram2004/capstone-backend:test

      - name: Run Backend Tests
        run: |
          docker run --rm \
            -v "$PWD/backend:/app" \
            vempatisriram2004/capstone-backend:test \
            python -m pytest test_app.py -q -o cache_dir=/tmp/pytest

      - name: Trivy Scan Backend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: vempatisriram2004/capstone-backend:test
          severity: CRITICAL,HIGH
          exit-code: 1
          ignore-unfixed: true

      - name: Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: vempatisriram2004/capstone-backend:latest
